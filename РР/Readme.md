# Модуль оптимизации размещения логистических складов

**Вариант 16 ППОИС**

Система для определения оптимального количества и расположения складов торговой сети с целью минимизации транспортных затрат.

---

## Постановка задачи

### Дано
- Торговая сеть из N магазинов
- Каждый магазин имеет:
  - Координаты (X, Y) на карте
  - Объём ежемесячных поставок (тонн/месяц)

### Найти
Оптимальное количество складов (1, 2 или 3) и их расположение для минимизации транспортных затрат.

### Ограничения
- Минимум 3 магазина в сети
- Рассматриваются варианты с 1, 2 или 3 складами
- Каждый магазин обслуживается ближайшим складом

---

## Как рассчитывается лучшая позиция склада

### Шаг 1: Взвешенный центроид

Для группы магазинов оптимальная позиция склада — это **взвешенный центроид**, где веса — объёмы поставок:

```
X_склад = Σ(x_i × volume_i) / Σ(volume_i)
Y_склад = Σ(y_i × volume_i) / Σ(volume_i)
```

**Почему это оптимально?**
- Склад располагается ближе к магазинам с большим объёмом поставок
- Минимизируется общее "транспортное плечо" (расстояние × объём)

### Шаг 2: Кластеризация (для 2+ складов)

Для нескольких складов используется **K-means кластеризация**:

1. Магазины разбиваются на K групп (кластеров)
2. Для каждого кластера рассчитывается свой центроид
3. Итеративно уточняются границы кластеров и позиции центроидов

### Шаг 3: Расчёт затрат

Транспортные затраты для варианта размещения:

```
Cost = Σ (расстояние_до_склада × объём × тариф × 2)
```

Где:
- **расстояние** — евклидово расстояние от магазина до ближайшего склада
- **объём** — месячный объём поставок (т)
- **тариф** — стоимость перевозки (руб/км·т), по умолчанию 12
- **×2** — учёт доставки туда и обратно

### Шаг 4: Выбор лучшего варианта

Сравниваются три варианта:
- 1 склад: один центральный склад для всей сети
- 2 склада: магазины разбиты на 2 группы
- 3 склада: магазины разбиты на 3 группы

Выбирается вариант с **минимальными затратами**.

---

## Пример расчёта

### Входные данные (5 магазинов)

| ID | X | Y | Объём (т/мес) |
|----|---|---|---------------|
| 1 | 10 | 15 | 200 |
| 2 | 25 | 30 | 350 |
| 3 | 45 | 20 | 180 |
| 4 | 35 | 45 | 280 |
| 5 | 55 | 35 | 320 |

### Результат

| Вариант | Складов | Затраты (руб/мес) | Экономия |
|---------|---------|-------------------|----------|
| K=1 | 1 | ~85 000 | — |
| K=2 | 2 | ~52 000 | ~39% |
| K=3 | 3 | ~38 000 | ~55% |

**Рекомендация:** 3 склада (максимальная экономия)

---

## Структура модуля

```
logistics-module/
├── README.md                 # Этот файл
├── CMakeLists.txt            # Конфигурация сборки
├── LogisticsModule.cpp       # Регистрация модуля
├── agents/                   # Агенты системы
│   ├── WarehouseOptimizationAgent.*   # Оркестратор
│   ├── FileParseAgent.*               # Парсинг CSV
│   ├── DataValidationAgent.*          # Валидация
│   ├── ClusteringAgent.*              # K-means
│   ├── CostCalculationAgent.*         # Расчёт затрат
│   ├── VariantComparisonAgent.*       # Сравнение
│   └── ReportGenerationAgent.*        # Отчёт
├── keynodes/                 # Ключевые узлы SC-памяти
├── utils/                    # Утилиты
│   ├── CsvParser.*           # Парсинг CSV
│   └── GeometryUtils.*       # Геометрические расчёты
├── docs/                     # Документация
└── test/                     # Тесты (21 теста)
```

---



### Структура отчёта

```
optimization_report
    <- concept_optimization_report;;
    => nrel_shop_count: [5];;
    => nrel_single_warehouse_variant: variant_1;;
    => nrel_two_warehouses_variant: variant_2;;
    => nrel_three_warehouses_variant: variant_3;;
    => nrel_recommendation: variant_3;;
```
# Модуль оптимизации размещения складов

Модуль решает задачу оптимального размещения складов для торговой сети с целью минимизации транспортных затрат на доставку товаров в магазины.

---

## Обзор агентов

Модуль содержит **7 агентов**, работающих совместно:

| Агент | Назначение | Класс действия |
|-------|------------|----------------|
| [FileParseAgent](FileParseAgent.md) | Парсинг CSV файла с данными магазинов | `action_parse_input_file` |
| [DataValidationAgent](DataValidationAgent.md) | Валидация входных данных | `action_validate_data` |
| [ClusteringAgent](ClusteringAgent.md) | K-means кластеризация магазинов | `action_cluster_shops` |
| [CostCalculationAgent](CostCalculationAgent.md) | Расчёт транспортных затрат | `action_calculate_cost` |
| [VariantComparisonAgent](VariantComparisonAgent.md) | Сравнение вариантов размещения | `action_compare_variants` |
| [ReportGenerationAgent](ReportGenerationAgent.md) | Формирование итогового отчёта | `action_generate_report` |
| [WarehouseOptimizationAgent](WarehouseOptimizationAgent.md) | Оркестратор (вызывает все агенты) | `action_optimize_warehouse_placement` |

---

## Архитектура взаимодействия

```
┌─────────────────────────────────────────────────────────────────┐
│                  WarehouseOptimizationAgent                     │
│                       (оркестратор)                             │
└─────────────────────────────────────────────────────────────────┘
                              │
       ┌──────────────────────┼──────────────────────┐
       ▼                      ▼                      ▼
┌─────────────┐      ┌─────────────────┐      ┌─────────────┐
│FileParseAgent│ ──▶ │DataValidationAgent│ ──▶ │ClusteringAgent│
└─────────────┘      └─────────────────┘      └─────────────┘
                                                     │
                                              ┌──────┴──────┐
                                              ▼      ▼      ▼
                                            K=1    K=2    K=3
                                              │      │      │
                                              ▼      ▼      ▼
                                         ┌─────────────────────┐
                                         │ CostCalculationAgent │
                                         │     (×3 вызова)      │
                                         └─────────────────────┘
                                                     │
                                                     ▼
                                         ┌─────────────────────┐
                                         │VariantComparisonAgent│
                                         └─────────────────────┘
                                                     │
                                                     ▼
                                         ┌─────────────────────┐
                                         │ReportGenerationAgent │
                                         └─────────────────────┘
```

---

## Пайплайн обработки

### Шаг 1: Парсинг файла
**FileParseAgent** читает CSV файл и создаёт структуру торговой сети в SC-памяти.

### Шаг 2: Валидация данных
**DataValidationAgent** проверяет корректность данных:
- Минимум 3 магазина
- Наличие обязательных атрибутов (id, x, y, volume)

> **Улучшено:** Оркестратор теперь проверяет флаг `nrel_is_valid` из результата валидации и завершается с ошибкой, если данные невалидны.

### Шаг 3: Кластеризация
**ClusteringAgent** выполняет K-means кластеризацию для K=1, K=2, K=3:
- Группирует магазины в кластеры
- Определяет оптимальные координаты складов (взвешенный центроид)

### Шаг 4: Расчёт затрат
**CostCalculationAgent** рассчитывает транспортные затраты для каждого варианта:
```
Cost = Σ (расстояние × объём × тариф)
тариф = 50 руб/(км·т)
```

### Шаг 5: Сравнение вариантов
**VariantComparisonAgent** сравнивает варианты и выбирает оптимальный:
- Определяет вариант с минимальными затратами
- Рассчитывает экономию относительно 1 склада

### Шаг 6: Формирование отчёта
**ReportGenerationAgent** создаёт итоговый отчёт со всеми вариантами и рекомендацией.

> **Улучшено:** Оркестратор теперь проверяет успешность формирования отчёта и корректно обрабатывает ошибки.

---

## Ключевые концепты SC-памяти

### Классы узлов

| Концепт | Описание |
|---------|----------|
| `concept_trading_network` | Торговая сеть |
| `concept_shop` | Магазин |
| `concept_warehouse` | Склад |
| `concept_placement_variant` | Вариант размещения |
| `concept_optimization_report` | Отчёт по оптимизации |

### Отношения

| Отношение | Описание | Тип |
|-----------|----------|-----|
| `nrel_id` | Идентификатор | Неролевое |
| `nrel_x` | Координата X | Неролевое |
| `nrel_y` | Координата Y | Неролевое |
| `nrel_delivery_volume` | Объём поставки (т/мес) | Неролевое |
| `nrel_monthly_cost` | Месячные затраты (руб) | Неролевое |
| `nrel_economy_percent` | Процент экономии | Неролевое |
| `nrel_warehouse` | Склад в варианте | Неролевое |
| `nrel_recommendation` | Рекомендация | Неролевое |
| `nrel_parsed_data` | Распарсенные данные | Неролевое |
| `nrel_shop_count` | Количество магазинов | Неролевое |

---

## Формат входных данных

CSV файл с разделителем `;`:

```csv
shop_id;name;x;y;volume
1;Магазин_1;10;15;200
2;Магазин_2;25;30;350
3;Магазин_3;45;20;180
```

| Поле | Тип | Описание |
|------|-----|----------|
| shop_id | int | Уникальный идентификатор |
| name | string | Название магазина |
| x | double | Координата X (км) |
| y | double | Координата Y (км) |
| volume | double | Объём поставки (т/мес) |

---

## Обработка ошибок

Оркестратор реализует **строгую проверку ошибок** на каждом шаге:

| Шаг | Агент | Проверка |
|-----|-------|----------|
| 1 | FileParseAgent | Успешность парсинга файла |
| 2 | DataValidationAgent | Успешность + проверка `nrel_is_valid` |
| 3-8 | ClusteringAgent, CostCalculationAgent | Успешность кластеризации и расчёта |
| 9 | VariantComparisonAgent | Успешность сравнения |
| 10 | ReportGenerationAgent | Успешность формирования отчёта |

При ошибке на любом шаге оркестратор немедленно завершается с `action.FinishWithError()`.

---

## Логирование

Каждый агент пишет логи в директорию `logs/`:

```
logs/
├── FileParseAgent.log
├── DataValidationAgent.log
├── ClusteringAgent.log
├── CostCalculationAgent.log
├── VariantComparisonAgent.log
├── ReportGenerationAgent.log
└── WarehouseOptimizationAgent.log
```

---

## Документация по агентам

- [FileParseAgent](FileParseAgent.md) — парсинг CSV
- [DataValidationAgent](DataValidationAgent.md) — валидация данных
- [ClusteringAgent](ClusteringAgent.md) — кластеризация
- [CostCalculationAgent](CostCalculationAgent.md) — расчёт затрат
- [VariantComparisonAgent](VariantComparisonAgent.md) — сравнение вариантов
- [ReportGenerationAgent](ReportGenerationAgent.md) — формирование отчёта
- [WarehouseOptimizationAgent](WarehouseOptimizationAgent.md) — оркестратор

# Тесты модуля логистики

Unit и интеграционные тесты для агентов оптимизации размещения складов.

**Всего: 21 тест, 7 файлов, покрыты все 7 агентов модуля.**

---
## Структура директории

```
test/
├── README.md                         # Документация (этот файл)
├── test_data/                        # Тестовые CSV файлы
│   ├── shops_3.csv                   # 3 магазина (минимум)
│   ├── shops_5.csv                   # 5 магазинов
│   └── shops_15.csv                  # 15 магазинов
├── test_csv_parser.cpp               # 4 теста
├── test_data_validation_agent.cpp    # 3 теста
├── test_clustering_agent.cpp         # 5 тестов
├── test_cost_calculation_agent.cpp   # 3 теста
├── test_variant_comparison_agent.cpp # 2 теста
├── test_report_generation_agent.cpp  # 2 теста
└── test_integration.cpp              # 2 теста
```

---

## Описание тестовых файлов

Каждый файл описан в едином формате:
- **Файл** — имя исходного файла
- **Компонент** — тестируемый агент/модуль
- **Тесты** — количество тестов
- **Покрывает** — какой агент из модуля покрывается
- **Таблица тестов** — что проверяет каждый тест

---

### 1. `test_csv_parser.cpp`

| | |
|---|---|
| **Компонент** | `CsvParser` (utils) |
| **Тестов** | 4 |
| **Покрывает** | FileParseAgent, WarehouseOptimizationAgent |

**Тесты:**

| Тест | Входные данные | Что проверяет | Критерий успеха |
|------|----------------|---------------|-----------------|
| `ParseFile_5Shops` | `shops_5.csv` | Парсинг 5 магазинов | 5 записей, координаты верны |
| `ParseFile_15Shops` | `shops_15.csv` | Парсинг 15 магазинов | 15 записей |
| `ParseFile_3Shops` | `shops_3.csv` | Минимальный набор | 3 записи, x=10*id |
| `Error_FileNotFound` | несуществующий | Обработка ошибки | return false, сообщение |

**Проверяемая логика:**
- Чтение CSV с разделителем `;`
- Извлечение полей: id, name, x, y, volume
- Обработка ошибок

---

### 2. `test_data_validation_agent.cpp`

| | |
|---|---|
| **Компонент** | `DataValidationAgent` |
| **Тестов** | 3 |
| **Покрывает** | DataValidationAgent |

**Тесты:**

| Тест | Входные данные | Что проверяет | Критерий успеха |
|------|----------------|---------------|-----------------|
| `ValidData_5Shops` | 5 магазинов | Валидация корректных данных | Успех, count=5 |
| `InvalidData_TooFewShops` | 2 магазина | Недостаточно магазинов | Ошибка |
| `ValidData_15Shops` | 15 магазинов | Большой набор | Успех, count=15 |

**Проверяемая логика:**
- Минимум 3 магазина
- Наличие обязательных атрибутов
- Корректность структуры SC-памяти

---

### 3. `test_clustering_agent.cpp`

| | |
|---|---|
| **Компонент** | `ClusteringAgent` |
| **Тестов** | 5 |
| **Покрывает** | ClusteringAgent |

**Тесты:**

| Тест | K | Что проверяет | Критерий успеха |
|------|---|---------------|-----------------|
| `Clustering_K1_SingleWarehouse` | 1 | Один склад | Координаты = центроид |
| `Clustering_K2_TwoWarehouses` | 2 | Два склада | 2 склада с разными координатами |
| `Clustering_K3_ThreeWarehouses` | 3 | Три склада | 3 склада |
| `Error_InvalidK_Zero` | 0 | Невалидный K | Ошибка |
| `Error_K_MoreThanShops` | 10 | K > N | Ошибка |

**Проверяемая логика:**
- K-means кластеризация
- Формула: `X = Σ(x_i * vol_i) / Σ(vol_i)`
- Граничные случаи

---

### 4. `test_cost_calculation_agent.cpp`

| | |
|---|---|
| **Компонент** | `CostCalculationAgent` |
| **Тестов** | 3 |
| **Покрывает** | CostCalculationAgent |

**Тесты:**

| Тест | Варианты | Что проверяет | Критерий успеха |
|------|----------|---------------|-----------------|
| `CostCalculation_SingleWarehouse` | K=1 | Расчёт для 1 склада | cost > 0 |
| `CostCalculation_TwoWarehouses` | K=2 | Расчёт для 2 складов | cost_2 < cost_1 |
| `CostComparison_AllVariants` | K=1,2,3 | Сравнение всех | cost_1 > cost_2 > cost_3 |

**Проверяемая логика:**
- Формула: `Cost = Σ(dist * vol * 50)`
- Магазин → ближайший склад
- Больше складов = меньше затрат

---

### 5. `test_variant_comparison_agent.cpp`

| | |
|---|---|
| **Компонент** | `VariantComparisonAgent` |
| **Тестов** | 2 |
| **Покрывает** | VariantComparisonAgent |

**Тесты:**

| Тест | Что проверяет | Критерий успеха |
|------|---------------|-----------------|
| `CompareThreeVariants_SelectBest` | Выбор лучшего варианта | Выбран min cost |
| `EconomyCalculation` | Расчёт экономии | economy = 100*(1 - cost_k/cost_1) |

**Проверяемая логика:**
- Определение лучшего варианта
- Расчёт процента экономии
- Добавление `nrel_recommendation`

---

### 6. `test_report_generation_agent.cpp`

| | |
|---|---|
| **Компонент** | `ReportGenerationAgent` |
| **Тестов** | 2 |
| **Покрывает** | ReportGenerationAgent |

**Тесты:**

| Тест | Входные данные | Что проверяет | Критерий успеха |
|------|----------------|---------------|-----------------|
| `GenerateReport_5Shops` | 5 магазинов | Структура отчёта | Все связи созданы |
| `GenerateReport_15Shops` | 15 магазинов | Большой отчёт | shop_count=15 |

**Проверяемая логика:**
- Создание `concept_optimization_report`
- Атрибут `nrel_shop_count`
- Связи с вариантами и рекомендацией

---

### 7. `test_integration.cpp`

| | |
|---|---|
| **Компонент** | Полный пайплайн |
| **Тестов** | 2 |
| **Покрывает** | WarehouseOptimizationAgent (логика оркестратора) |

**Тесты:**

| Тест | Входные данные | Что проверяет | Критерий успеха |
|------|----------------|---------------|-----------------|
| `FullPipeline_SmallData` | 5 магазинов | Полная цепочка | Все шаги успешны |
| `FullPipeline_FullData` | 15 магазинов | Большой набор | 3 варианта сравнены |

**Проверяемая логика:**
- Validation → Clustering(×3) → Cost(×3) → Comparison
- Передача данных через SC-память
- Корректность финального результата

---

## Тестовые данные

Файлы в `test_data/` (формат: разделитель `;`):

| Файл | Магазинов | Назначение |
|------|-----------|------------|
| `shops_3.csv` | 3 | Минимальный валидный набор |
| `shops_5.csv` | 5 | Основной тестовый набор |
| `shops_15.csv` | 15 | Полный набор |

Формат:
```csv
shop_id;name;x;y;volume
1;Магазин_1;10;15;200
```

---

## Матрица покрытия агентов

| Агент | Тестовый файл | Тестов |
|-------|---------------|--------|
| FileParseAgent | `test_csv_parser.cpp` | 4 |
| DataValidationAgent | `test_data_validation_agent.cpp` | 3 |
| ClusteringAgent | `test_clustering_agent.cpp` | 5 |
| CostCalculationAgent | `test_cost_calculation_agent.cpp` | 3 |
| VariantComparisonAgent | `test_variant_comparison_agent.cpp` | 2 |
| ReportGenerationAgent | `test_report_generation_agent.cpp` | 2 |
| WarehouseOptimizationAgent | `test_integration.cpp` | 2 |

**Итого: 7 агентов, 21 тест**

---

## Зависимости тестов

Тесты используют **только**:
- `sc-memory` — фреймворк OSTIS (через Conan)
- `GTest` — фреймворк тестирования (через Conan)
- Код модуля `logistics-module`

**Никаких внешних сервисов, БД или сети не требуется.**

---
## Автор
Васкан А.Д., Баленкова Б.И., Рябая Ю.С.
